name: BikeFit Google Console Final Ultimate
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: ğŸ” ì™„ì „ ìºì‹œ ì‚­ì œ + ì„œëª… ê°•ì œ ì ìš© + ë¡œê·¸ ìƒì„¸
        run: |
          # ëª¨ë“  ìºì‹œ ì œê±° (fallback 99% ì°¨ë‹¨)
          flutter clean
          rm -rf $HOME/.gradle/caches/ $HOME/.pub-cache
          rm -rf android/.gradle android/app/build

          flutter pub cache repair
          flutter pub get

          # í”„ë¡œì íŠ¸ ì¬ìƒì„±
          flutter create . --platforms android --overwrite

          # JKS ë³µì‚¬ ì•ˆì „ì¥ì¹˜
          mkdir -p android/app
          cp release.jks android/app/release.jks || (echo "release.jks íŒŒì¼ ì—†ìŒ! ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ í™•ì¸" && exit 1)

          # key.properties ìƒì„±
          cat <<EOF > android/key.properties
          storePassword=Sodomaki80
          keyPassword=Sodomaki80
          keyAlias=fresh-upload-key
          storeFile=release.jks
          EOF

          # build.gradleì— release ë¸”ë¡ ê°•ì œ ì¶”ê°€ (ì¡´ì¬ ì—¬ë¶€ ë¬´ê´€)
          sed -i '/signingConfigs {/a \        release {\n            storeFile file("release.jks")\n            storePassword "Sodomaki80"\n            keyAlias "fresh-upload-key"\n            keyPassword "Sodomaki80"\n        }' android/app/build.gradle || true

          # debug ì°¸ì¡° ì™„ì „ ì œê±° + release ê°•ì œ
          sed -i 's/signingConfig signingConfigs.debug/signingConfig signingConfigs.release/g' android/app/build.gradle
          sed -i 's/signingConfigs.debug//g' android/app/build.gradle
          sed -i '/buildTypes {/a \        signingConfig signingConfigs.release' android/app/build.gradle || true

          # ì„¤ì • ë¡œê·¸ ì¶œë ¥
          cat android/key.properties
          grep -A 20 signingConfigs android/app/build.gradle

      - name: AAB ë¹Œë“œ + signing ë¡œê·¸ ì¶”ì¶œ
        run: |
          flutter build appbundle --release --no-tree-shake-icons --verbose > build_log.txt 2>&1
          grep -i "signing\|keystore\|alias\|fresh-upload-key\|validateSigning\|release" build_log.txt

      - name: AAB ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: BikeFit_FINAL_AAB
          path: build/app/outputs/bundle/release/app-release.aab

      - name: ë¡œê·¸ ì•„í‹°íŒ©íŠ¸
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Debug_Logs
          path: build_log.txt
