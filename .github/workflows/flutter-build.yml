name: BikeFit Final Stable Build V9
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Java Setup
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Flutter Setup
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: Android Build Environment Fix
        run: |
          echo "ğŸ§± í™˜ê²½ ì •ë¦¬ ë° ì„¤ì • ì‹œì‘"

          flutter clean
          flutter pub get

          # Gradle íŒŒì¼ ë²„ì „ ë§ì¶¤
          sed -i 's/compileSdkVersion [0-9]\+/compileSdkVersion 34/' android/app/build.gradle
          sed -i 's/targetSdkVersion [0-9]\+/targetSdkVersion 34/' android/app/build.gradle
          sed -i 's/minSdkVersion [0-9]\+/minSdkVersion 21/' android/app/build.gradle

          # build.gradle (í”„ë¡œì íŠ¸ ë£¨íŠ¸)ì˜ Gradle í”ŒëŸ¬ê·¸ì¸ ë²„ì „ ìµœì‹ í™”
          sed -i 's/com.android.tools.build:gradle:[0-9\.]\+/com.android.tools.build:gradle:8.2.2/' android/build.gradle

          # gradle-wrapper.properties ìµœì‹  ë²„ì „ ì§€ì •
          sed -i 's/distributionUrl=.*/distributionUrl=https\\\:\/\/services.gradle.org\\/distributions\\/gradle-8.7-bin.zip/' android/gradle/wrapper/gradle-wrapper.properties

          # Multidex í™œì„±í™” ë° ì˜ì¡´ì„± ì¶”ê°€
          if ! grep -q "multiDexEnabled true" android/app/build.gradle; then
            sed -i '/defaultConfig {/a \        multiDexEnabled true' android/app/build.gradle
          fi
          if ! grep -q 'androidx.multidex' android/app/build.gradle; then
            sed -i '/dependencies {/a \    implementation "androidx.multidex:multidex:2.0.1"' android/app/build.gradle
          fi

          # Gradle ë©”ëª¨ë¦¬ ì—¬ìœ  í™•ë³´
          echo "org.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError" >> android/gradle.properties

          # Kotlin ë²„ì „ í†µì¼
          if grep -q "kotlin-gradle-plugin" android/build.gradle; then
            sed -i 's/ext.kotlin_version = .*/ext.kotlin_version = "1.9.25"/' android/build.gradle
          fi

          echo "ğŸš€ ë¹Œë“œ ì‹œì‘"
          flutter build apk --debug --no-tree-shake-icons --no-shrink

      - name: APK íŒŒì¼ ì¶”ì¶œ
        uses: actions/upload-artifact@v4
        with:
          name: IndoorBikeFit_Fixed_V9
          path: build/app/outputs/flutter-apk/app-debug.apk
