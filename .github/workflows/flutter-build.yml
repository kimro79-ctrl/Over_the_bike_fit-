name: BikeFit Google Console Final Ultimate Fixed 2026
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java & Flutter
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: ğŸ” ì„œëª… ì„¤ì • ê°•ì œ ì¬ì •ì˜ + ëª¨ë“  ìºì‹œ ì œê±°
        run: |
          flutter clean
          rm -rf $HOME/.gradle/caches/ $HOME/.pub-cache android/.gradle android/app/build android/app/.gradle

          flutter pub cache repair
          flutter pub get

          flutter create . --platforms android --overwrite

          mkdir -p android/app
          cp release.jks android/app/release.jks || exit 1

          cat <<EOF > android/key.properties
          storePassword=Sodomaki80
          keyPassword=Sodomaki80
          keyAlias=fresh-upload-key
          storeFile=release.jks
          EOF

          # ê¸°ì¡´ signingConfigs ì „ì²´ ì‚­ì œ í›„ ìƒˆë¡œ ì‚½ì… (fallback ì™„ì „ ì°¨ë‹¨)
          sed -i '/signingConfigs {/,/}/d' android/app/build.gradle
          sed -i '/android {/a signingConfigs {\n    release {\n        storeFile file("release.jks")\n        storePassword "Sodomaki80"\n        keyAlias "fresh-upload-key"\n        keyPassword "Sodomaki80"\n    }\n}' android/app/build.gradle

          sed -i '/buildTypes {/a \        signingConfig signingConfigs.release' android/app/build.gradle

          echo "=== ìµœì¢… signingConfigs í™•ì¸ ==="
          grep -A 30 signingConfigs android/app/build.gradle

      - name: AAB ë¹Œë“œ + ì„œëª… ë¡œê·¸ ì¶”ì¶œ
        run: |
          flutter build appbundle --release --no-tree-shake-icons --verbose > build_log.txt 2>&1
          grep -i "signing\|keystore\|alias\|fresh-upload-key\|validateSigning\|release" build_log.txt || echo "ì„œëª… ë¡œê·¸ ë¯¸ê²€ì¶œ"

      - name: AAB ì•„í‹°íŒ©íŠ¸
        uses: actions/upload-artifact@v4
        with:
          name: BikeFit_FINAL_AAB
          path: build/app/outputs/bundle/release/app-release.aab

      - name: ë¡œê·¸ ì•„í‹°íŒ©íŠ¸
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Debug_Logs
          path: build_log.txt
